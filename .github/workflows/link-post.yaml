name: Link Post

on:
  pull_request:
    types: [opened]
    branches:
      - main

jobs:
  extract-week-num:
    runs-on: ubuntu-latest

    outputs:
      week: ${{ steps.extract.outputs.week }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Print Context
      run: | 
        echo ${{ github.ref }}
        echo ${{ github.ref_name }}
        echo ${{ github.head_ref }}
        echo ${{ github.action_status }}
        echo ${{ github.event_name }}
        echo ${{ github.event_path }}
    - name: Read Week number from Branch
      id: extract
      run: |
        cd ./script
        echo "week=$(python get_week_number.py ${{ github.head_ref }})" >> $GITHUB_OUTPUT
    - name: Print Week number
      run: echo ${{ steps.extract.outputs.week }}
 
  extract-chapter-info:
    runs-on: ubuntu-latest
    needs: extract-week-num

    outputs:
      info: ${{ steps.extract-chapter-json.outputs.info }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Print extract Week number
        run: echo ${{ needs.extract-week-num.outputs.week }}
      - name: Read chapter-info from JSON
        id: extract-chapter-json
        run: |
          cd ./script
          echo "info<<EOF" >> $GITHUB_OUTPUT
          python read_json.py ./json/chapter.json ${{ needs.extract-week-num.outputs.week }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Print chapter info
        run: echo "${{ steps.extract-chapter-json.outputs.info }}"
      
  link-comment:
    runs-on: ubuntu-latest
    needs: [extract-week-num, extract-chapter-info]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Print Week number and Chapter Info
        run: |
          echo ${{ needs.extract-week-num.outputs.week }} 
          echo "${{ needs.extract-chapter-info.outputs.info }}"

      - name: Auto Comment on Pull Request
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: wow-actions/auto-comment@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          pullRequestOpened: |
            ğŸ‘‹ @{{ author }} ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!
            Udemy - ["AWS Certified Solutions Architect Associateì‹œí—˜í•©ê²©! 2025"](https://www.udemy.com/course/best-aws-certified-solutions-architect-associate)
            
            `${{ needs.extract-week-num.outputs.week }} ì£¼ì°¨`ë¥¼ í•™ìŠµí•˜ì…¨ë„¤ìš”!
            í•´ë‹¹ ì£¼ì°¨ì˜ ê°•ì˜ ëª©ë¡ì„ ì•Œë ¤ë“œë¦´ê»˜ìš”!

            ### ğŸ“š ${{ needs.extract-week-num.outputs.week }} ì£¼ì°¨ ê°•ì˜ ëª©ë¡
            
            ${{ needs.extract-chapter-info.outputs.info }}
            
            ê°•ì˜ë¥¼ ë“¤ìœ¼ì‹œë©´ì„œ ê¶ê¸ˆí•œ ì ì´ë‚˜ ê³µìœ í•˜ê³  ì‹¶ì€ ë‚´ìš©ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€
            - [Discussions Q&A](https://github.com/Udemy-kor/aws-saa/discussions/categories/q-a)
            - ë‹¨í†¡ë°©ì— ë‚¨ê²¨ ì£¼ì„¸ìš”! ğŸ˜Š

  create-and-add-label:
    runs-on: ubuntu-latest
    needs: [extract-week-num]
    if: always()
    steps:
    - name: Create and Add Label
      uses: actions/github-script@v5
      with:
        script: |
          const labelName = '${{ needs.extract-week-num.outputs.week }} ì£¼ì°¨';
          const labelColor = 'ffffff'; // ë¼ë²¨ ìƒ‰ìƒì„ HEX ì½”ë“œë¡œ ì„¤ì •

          // ë¼ë²¨ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          try {
            await github.rest.issues.getLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: labelName
            });
          } catch (error) {
            // ë¼ë²¨ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±
            await github.rest.issues.createLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: labelName,
              color: labelColor,
            });
          }

          // í’€ ë¦¬í€˜ìŠ¤íŠ¸ì— ë¼ë²¨ ì¶”ê°€
          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: [labelName, 'ì§„í–‰ ì¤‘']
          });
